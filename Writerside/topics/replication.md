# Распределенная система

Раздел включает проектирование распределённой системы на основе встраиваемого ядра хранилища,
включая реализацию RAFT для репликации и шардирование для масштабирования.

• **Репликация**: Обеспечить отказоустойчивость и высокую доступность за счёт репликации данных между несколькими узлами с помощью алгоритма консенсуса RAFT.

• **Шардирование**: Распределить данные по шардам (logical partitions)

## Компоненты распределенной системы

### Ядро хранилища (LSMStorage)

<a href="storage.md">Подробное описание ядра хранилища здесь</a>

### RAFT-репликация

Репликация
 : Каждый узел в группе RAFT содержит локальную копию LSMStorage.  
 : Группа RAFT обеспечивает согласованное состояние системы через выбор лидера, репликацию логов и периодические heartbeat-сообщения.

### Шардирование

Шардирование
 : Данные распределяются по логическим шардам. Каждый шард может поддерживаться отдельной группой узлов (каждая группа использует RAFT для репликации).
 : Метаданные, описывающие назначение шарда (например, диапазон ключей или позиция в кольце консистентного хеширования), могут храниться в специальном сервисе или распределённом реестре (например, используя ZooKeeper / etcd / Apache Zookeeper, либо собственное решение).

### Клиентский API и Proxy

Клиентский API и Proxy
 : Слой, принимающий внешние запросы (например, через REST API или gRPC) и направляющий их в соответствующую RAFT-группу/шард.
 : Может включать логическую маршрутизацию запросов (routing requests):  
 : Клиент обращается к входной точке, которая определяет нужный шард по ключу (через consistent hashing).  
 : Запрос направляется к лидеру RAFT группы этого шарда.

### Сервис администрирования и мониторинга

Сервис администрирования и мониторинга
 : Веб-интерфейс или консоль для визуализации.



<code-block lang="plantuml">

</code-block>

### Запуск кластера

<code-block lang="bash">
docker network create lsm-net

# --- n1 ---
docker run -d --name n1 --network lsm-net \
-p 8761:8761 -p 8081:8081 \
-e PEER_ID=n1 -e PORT=8761 -e HTTP_PORT=8081 \
-e GROUP_ID=3fa85f64-5717-4562-b3fc-2c963f66afa6 \
-e PEERS="n1:n1:8761,n2:n2:8762,n3:n3:8763" \
-e FLUSH_THRESHOLD_BYTES=1024 \
-e BLOOM_FPP=0.02 \
-e BLOOM_HASH_FUNCS=2 \
-v lsm_n1:/data \
axothy/lsmraft:latest

# --- n2 ---
docker run -d --name n2 --network lsm-net \
-p 8762:8762 -p 8082:8082 \
-e PEER_ID=n2 -e PORT=8762 -e HTTP_PORT=8082 \
-e GROUP_ID=3fa85f64-5717-4562-b3fc-2c963f66afa6 \
-e PEERS="n1:n1:8761,n2:n2:8762,n3:n3:8763" \
-e FLUSH_THRESHOLD_BYTES=1024 \
-e BLOOM_FPP=0.02 \
-e BLOOM_HASH_FUNCS=2 \
-v lsm_n2:/data \
axothy/lsmraft:latest

# --- n3 ---
docker run -d --name n3 --network lsm-net \
-p 8763:8763 -p 8083:8083 \
-e PEER_ID=n3 -e PORT=8763 -e HTTP_PORT=8083 \
-e GROUP_ID=3fa85f64-5717-4562-b3fc-2c963f66afa6 \
-e PEERS="n1:n1:8761,n2:n2:8762,n3:n3:8763" \
-e FLUSH_THRESHOLD_BYTES=1024 \
-e BLOOM_FPP=0.02 \
-e BLOOM_HASH_FUNCS=2 \
-v lsm_n3:/data \
axothy/lsmraft:latest
</code-block>


## ЯП и технологии

Коммуникационный слой

Для обмена сообщениями между узлами, а также для приема клиентских запросов, можно использовать:

- gRPC:
- Современный стандарт для межсервисного общения.
- Позволяет задокументировать API с помощью Protocol Buffers, что упрощает сериализацию и версионирование.




